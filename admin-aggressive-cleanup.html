<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aggressive Duplicate Cleanup | The Pearl Vista</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background: #1a1a1a;
            color: white;
            padding: 2rem;
            text-align: center;
        }
        .header h1 {
            margin: 0;
            color: #d4af37;
        }
        .content {
            padding: 2rem;
        }
        .warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 2rem;
        }
        .danger {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 2rem;
        }
        .btn {
            background: #d4af37;
            color: black;
            border: none;
            padding: 1rem 2rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        .btn:hover {
            background: #b8941f;
            transform: translateY(-2px);
        }
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        .btn-danger:hover {
            background: #c82333;
        }
        .results {
            margin-top: 2rem;
            padding: 1rem;
            border-radius: 8px;
            display: none;
        }
        .results.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .results.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        .stat-item {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
        }
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #d4af37;
        }
        .stat-label {
            color: #666;
            font-size: 0.9rem;
        }
        .kept-records {
            margin-top: 1rem;
            background: #e7f3ff;
            border: 1px solid #b3d9ff;
            padding: 1rem;
            border-radius: 8px;
        }
        .kept-records h4 {
            margin: 0 0 1rem 0;
            color: #0066cc;
        }
        .record-item {
            background: white;
            padding: 0.5rem;
            margin: 0.5rem 0;
            border-radius: 4px;
            border-left: 3px solid #0066cc;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üö® Aggressive Duplicate Cleanup Tool</h1>
            <p>Comprehensive duplicate removal and prevention system</p>
        </div>
        
        <div class="content">
            <div class="danger">
                <strong>‚ö†Ô∏è CRITICAL WARNING:</strong> This tool will permanently delete ALL duplicate booking records. 
                Make sure to backup your database before proceeding. Only one record from each duplicate group will be kept.
                This action cannot be undone!
            </div>
            
            <div class="warning">
                <strong>üìã What this tool does:</strong>
                <ul>
                    <li>Finds ALL duplicate bookings (not just recent ones)</li>
                    <li>Keeps the oldest record from each duplicate group</li>
                    <li>Deletes all other duplicate records</li>
                    <li>Adds a unique database constraint to prevent future duplicates</li>
                    <li>Updates booking_id for remaining records</li>
                </ul>
            </div>
            
            <button id="cleanupBtn" class="btn btn-danger" onclick="runAggressiveCleanup()">
                üßπ Run Aggressive Duplicate Cleanup
            </button>
            
            <div id="results" class="results"></div>
            
            <div id="stats" class="stats" style="display: none;">
                <div class="stat-item">
                    <div class="stat-number" id="duplicatesFound">0</div>
                    <div class="stat-label">Duplicate Groups Found</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="duplicateGroups">0</div>
                    <div class="stat-label">Groups Cleaned</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="deletedRecords">0</div>
                    <div class="stat-label">Records Deleted</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="remainingRecords">0</div>
                    <div class="stat-label">Remaining Records</div>
                </div>
            </div>
            
            <div id="keptRecords" class="kept-records" style="display: none;">
                <h4>üìã Records Kept (Oldest from each duplicate group):</h4>
                <div id="keptRecordsList"></div>
            </div>
        </div>
    </div>

    <script>
        async function runAggressiveCleanup() {
            const btn = document.getElementById('cleanupBtn');
            const results = document.getElementById('results');
            const stats = document.getElementById('stats');
            const keptRecords = document.getElementById('keptRecords');
            
            // Confirm action multiple times
            if (!confirm('‚ö†Ô∏è WARNING: This will permanently delete ALL duplicate bookings. Are you sure?')) {
                return;
            }
            
            if (!confirm('‚ö†Ô∏è SECOND WARNING: This action cannot be undone. Continue?')) {
                return;
            }
            
            if (!confirm('‚ö†Ô∏è FINAL WARNING: You are about to delete duplicate records. Proceed?')) {
                return;
            }
            
            btn.disabled = true;
            btn.textContent = 'üîÑ Running Aggressive Cleanup...';
            results.style.display = 'none';
            stats.style.display = 'none';
            keptRecords.style.display = 'none';
            
            try {
                const response = await fetch('Backend/aggressive_duplicate_cleanup.php');
                const data = await response.json();
                
                if (data.success) {
                    results.className = 'results success';
                    results.innerHTML = `
                        <h3>‚úÖ Aggressive Cleanup Completed Successfully!</h3>
                        <p><strong>${data.message}</strong></p>
                        <p>${data.summary}</p>
                    `;
                    
                    // Update stats
                    document.getElementById('duplicatesFound').textContent = data.duplicates_found;
                    document.getElementById('duplicateGroups').textContent = data.duplicate_groups_cleaned;
                    document.getElementById('deletedRecords').textContent = data.duplicate_records_deleted;
                    document.getElementById('remainingRecords').textContent = data.remaining_records;
                    
                    // Show kept records
                    if (data.kept_records && data.kept_records.length > 0) {
                        const keptRecordsList = document.getElementById('keptRecordsList');
                        keptRecordsList.innerHTML = '';
                        
                        data.kept_records.forEach(record => {
                            keptRecordsList.innerHTML += `
                                <div class="record-item">
                                    <strong>ID:</strong> ${record.id} | 
                                    <strong>Booking ID:</strong> ${record.booking_id} | 
                                    <strong>Customer:</strong> ${record.customer_name} | 
                                    <strong>Email:</strong> ${record.customer_email} | 
                                    <strong>Created:</strong> ${record.created_at}
                                </div>
                            `;
                        });
                        
                        keptRecords.style.display = 'block';
                    }
                    
                    stats.style.display = 'grid';
                } else {
                    results.className = 'results error';
                    results.innerHTML = `
                        <h3>‚ùå Aggressive Cleanup Failed</h3>
                        <p>${data.message}</p>
                    `;
                }
                
                results.style.display = 'block';
                
            } catch (error) {
                results.className = 'results error';
                results.innerHTML = `
                    <h3>‚ùå Network Error</h3>
                    <p>Failed to connect to the server. Please try again.</p>
                    <p>Error: ${error.message}</p>
                `;
                results.style.display = 'block';
            } finally {
                btn.disabled = false;
                btn.textContent = 'üßπ Run Aggressive Duplicate Cleanup';
            }
        }
    </script>
</body>
</html> 